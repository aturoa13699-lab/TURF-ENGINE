name: Site Build + Deploy (Reusable)

on:
  workflow_call:
    inputs:
      mode:
        description: "artifact | demo-run"
        required: true
        type: string
      run_date:
        description: "YYYY-MM-DD (optional; used for demo-run and summaries)"
        required: false
        type: string
        default: ""
      stake_cards_path:
        description: "Path containing stake cards JSON inputs for site/build_site.py"
        required: false
        type: string
        default: "out/stake_cards"
      artifact_name:
        description: "If mode=artifact: name of the artifact to download"
        required: false
        type: string
        default: ""
      send_email:
        description: "Send email with Pages URL (only if SMTP secrets present)"
        required: false
        type: boolean
        default: false
      upload_publish_json:
        description: "Upload publish.json as an artifact"
        required: false
        type: boolean
        default: true
      render_derive_extras:
        description: "If true, render-site may derive PRO extras on render (EV markers, race summaries). Default false keeps rendering read-only."
        required: false
        type: boolean
        default: false
      publish_derived_only:
        description: "If true, skip site/build_site.py and only publish derived digest pages under public/derived."
        required: false
        type: boolean
        default: false
    secrets:
      SMTP_SERVER:
        required: false
      SMTP_PORT:
        required: false
      SMTP_USERNAME:
        required: false
      SMTP_PASSWORD:
        required: false
      MAIL_FROM:
        required: false
      MAIL_TO:
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  PYTHONPATH: ${{ github.workspace }}

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    env:
      MAIL_TO: ${{ secrets.MAIL_TO || '' }}
      MAIL_FROM: ${{ secrets.MAIL_FROM || '' }}
      SMTP_SERVER: ${{ secrets.SMTP_SERVER || '' }}
      SMTP_PORT: ${{ secrets.SMTP_PORT || '465' }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME || '' }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Guardrail - forbid file-mode CLI
        run: |
          if grep -RIn --line-number -E 'python\s+cli/turf_cli\.py' .github/workflows; then
            echo "::error::File-mode CLI invocation found in workflows. Use: python -m cli.turf_cli"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-dev.txt
          python -m pip install -e .

      - name: Guardrail - ensure daily-digest command exists
        run: |
          set -euo pipefail
          if ! python -m cli.turf_cli --help | grep -q "daily-digest"; then
            echo "::error::Expected Typer command 'daily-digest' not found. This workflow depends on it."
            echo "CLI help output:"
            python -m cli.turf_cli --help || true
            exit 1
          fi

      - name: Resolve run date
        id: date
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.run_date }}" ]; then
            echo "run_date=${{ inputs.run_date }}" >> "$GITHUB_OUTPUT"
          else
            echo "run_date=$(TZ=Australia/Sydney date +%F)" >> "$GITHUB_OUTPUT"
          fi

      - name: Download stake-cards artifact
        if: ${{ inputs.mode == 'artifact' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: turf_daily.yml
          workflow_conclusion: success
          name: ${{ inputs.artifact_name }}
          branch: ${{ github.ref_name }}
          path: out/artifacts
        continue-on-error: true

      - name: Prepare stake cards input (artifact mode)
        if: ${{ inputs.mode == 'artifact' }}
        run: |
          set -euxo pipefail
          mkdir -p "${{ inputs.stake_cards_path }}"
          # Handle various artifact layouts from turf_daily.yml
          if [ -d out/artifacts/stake_cards ]; then
            cp -R out/artifacts/stake_cards/* "${{ inputs.stake_cards_path }}/"
          elif [ -d out/artifacts/out/stake_cards ]; then
            cp -R out/artifacts/out/stake_cards/* "${{ inputs.stake_cards_path }}/"
          elif ls out/artifacts/*.json 1>/dev/null 2>&1; then
            cp out/artifacts/*.json "${{ inputs.stake_cards_path }}/"
          else
            echo "::warning::No stake cards found in artifact. Falling back to demo-run."
            python -m cli.turf_cli demo-run --date "${{ steps.date.outputs.run_date }}" --out out/demo_run
            if [ -f out/demo_run/stake_card.json ]; then
              cp out/demo_run/stake_card.json "${{ inputs.stake_cards_path }}/"
            fi
          fi

      - name: Generate stake cards (demo-run mode)
        if: ${{ inputs.mode == 'demo-run' }}
        run: |
          set -euxo pipefail
          mkdir -p out/demo_run "${{ inputs.stake_cards_path }}"
          python -m cli.turf_cli demo-run --date "${{ steps.date.outputs.run_date }}" --out out/demo_run

          # Copy stake cards to expected location
          if [ -f out/demo_run/stake_card.json ]; then
            cp out/demo_run/stake_card.json "${{ inputs.stake_cards_path }}/"
          fi
          if [ -f out/demo_run/stake_card_pro.json ]; then
            cp out/demo_run/stake_card_pro.json "${{ inputs.stake_cards_path }}/"
          fi

      - name: Build daily digest (derived-only)
        run: |
          set -euxo pipefail
          rm -rf out/derived
          python -m cli.turf_cli daily-digest \
            --stake-cards "${{ inputs.stake_cards_path }}" \
            --out out/derived \
            --simulate \
            --write-per-meeting

      - name: Build site into public/
        if: ${{ !inputs.publish_derived_only }}
        run: |
          set -euxo pipefail
          rm -rf public
          RENDER_FLAGS=""
          if [ "${{ inputs.render_derive_extras }}" = "true" ]; then
            RENDER_FLAGS="--derive-on-render"
          fi

          python site/build_site.py --stake-cards "${{ inputs.stake_cards_path }}" --out public $RENDER_FLAGS

      - name: Prepare derived-only public skeleton
        if: ${{ inputs.publish_derived_only }}
        run: |
          set -euxo pipefail
          rm -rf public
          mkdir -p public/derived
          cat > public/index.html <<'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>TURF derived digests</title>
          </head>
          <body>
            <main>
              <h1>TURF derived digests</h1>
              <p>Digest artifacts are available under <a href="derived/index.html">/derived/index.html</a>.</p>
            </main>
          </body>
          </html>
          EOF

      - name: Stage digest artifacts into public/derived
        run: |
          set -euxo pipefail
          mkdir -p public/derived
          if [ -d out/derived ]; then
            cp -R out/derived/* public/derived/
          fi

      - name: Render digest HTML pages (derived-only)
        run: |
          set -euxo pipefail
          python -m turf.digest_pages --derived-dir out/derived --public-derived-dir public/derived

      - name: Ensure Pages metadata files
        run: |
          set -euo pipefail
          mkdir -p public
          touch public/.nojekyll

      - name: Smoke check (Lite-only render has no derived extras)
        if: ${{ !inputs.render_derive_extras }}
        run: |
          set -euo pipefail
          test -f public/index.html

          # Digest artifacts under public/derived are derived-only by design.
          if grep -RIn --line-number -E 'Top Picks|Value Picks|Trap Race|ev_band|ev_marker|risk_tags|risk_profile' public \
            --exclude-dir=derived; then
            echo "::error::Derived extras detected in Lite-only render. Expected read-only rendering."
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create publish.json
        if: ${{ always() }}
        # Must run after deploy so steps.deployment.outputs.page_url is populated.
        run: |
          set -euxo pipefail
          mkdir -p out/diagnostics
          cat > out/diagnostics/publish.json <<EOF
          {
            "run_date": "${{ steps.date.outputs.run_date }}",
            "mode": "${{ inputs.mode }}",
            "page_url": "${{ steps.deployment.outputs.page_url || '' }}",
            "daily_digest_md": "derived/daily_digest.md",
            "daily_digest_json": "derived/daily_digest.json"
          }
          EOF

      - name: Upload publish.json artifact
        if: ${{ always() && inputs.upload_publish_json }}
        uses: actions/upload-artifact@v4
        with:
          name: publish_json_${{ steps.date.outputs.run_date }}_${{ inputs.mode }}
          path: out/diagnostics/publish.json

      - name: Email config check (non-blocking)
        id: email_config
        if: ${{ always() }}
        run: |
          set -euo pipefail

          requested="${{ inputs.send_email }}"
          mail_to_set="false"
          mail_from_set="false"
          smtp_set="false"
          auth_set="false"
          smtp_port_set="false"

          [ -n "${MAIL_TO:-}" ] && mail_to_set="true"
          [ -n "${MAIL_FROM:-}" ] && mail_from_set="true"
          [ -n "${SMTP_SERVER:-}" ] && smtp_set="true"
          [ -n "${SMTP_USERNAME:-}" ] && [ -n "${SMTP_PASSWORD:-}" ] && auth_set="true"

          smtp_port="${SMTP_PORT:-}"
          if [ -n "$smtp_port" ]; then
            smtp_port_set="true"
          else
            smtp_port="465"
          fi

          can_email="false"
          missing=""

          if [ "$mail_to_set" != "true" ]; then missing="${missing} MAIL_TO"; fi
          if [ "$mail_from_set" != "true" ]; then missing="${missing} MAIL_FROM"; fi
          if [ "$smtp_set" != "true" ]; then missing="${missing} SMTP_SERVER"; fi
          if [ "$smtp_port_set" != "true" ]; then missing="${missing} SMTP_PORT"; fi
          if [ "$auth_set" != "true" ]; then missing="${missing} SMTP_USERNAME/SMTP_PASSWORD"; fi

          if [ -z "$missing" ]; then
            can_email="true"
          fi

          {
            echo "requested=${requested}"
            echo "can_email=${can_email}"
            echo "mail_to_set=${mail_to_set}"
            echo "mail_from_set=${mail_from_set}"
            echo "smtp_server_set=${smtp_set}"
            echo "smtp_auth_set=${auth_set}"
            echo "smtp_port=${smtp_port}"
            echo "smtp_port_set=${smtp_port_set}"
            echo "missing=${missing# }"
          } >> "$GITHUB_OUTPUT"

          {
            echo "### Email status"
            echo "- send_email requested: ${requested}"
            echo "- can_email: ${can_email}"
            echo "- smtp_port: ${smtp_port}"
            if [ -n "$missing" ]; then
              echo "- missing: ${missing# }"
            else
              echo "- missing: (none)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # Email step: caller must set send_email=true AND provide secrets
      # Note: secrets.* cannot be used in if: conditions for reusable workflows
      - name: Send email (optional)
        id: send_email
        if: ${{ inputs.send_email && steps.email_config.outputs.can_email == 'true' }}
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_SERVER }}
          server_port: ${{ steps.email_config.outputs.smtp_port }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          subject: "TURF daily site for ${{ steps.date.outputs.run_date }}"
          to: ${{ env.MAIL_TO }}
          from: ${{ env.MAIL_FROM }}
          secure: true
          html_body: |
            <p>The static site is live:</p>
            <p><a href="${{ steps.deployment.outputs.page_url }}">${{ steps.deployment.outputs.page_url }}</a></p>
            <p>Run date: ${{ steps.date.outputs.run_date }}</p>
            <p>Daily digest:</p>
            <ul>
              <li><a href="${{ steps.deployment.outputs.page_url }}derived/index.html">Digest index</a></li>
              <li><a href="${{ steps.deployment.outputs.page_url }}derived/daily_digest.html">Daily digest (HTML)</a></li>
              <li><a href="${{ steps.deployment.outputs.page_url }}derived/daily_digest.json">Daily digest (JSON)</a></li>
            </ul>

      - name: Email status summary
        if: ${{ always() }}
        env:
          EMAIL_ATTEMPTED: ${{ inputs.send_email && steps.email_config.outputs.can_email == 'true' }}
          EMAIL_OUTCOME: ${{ steps.send_email.outcome || 'not_run' }}
          EMAIL_CONCLUSION: ${{ steps.send_email.conclusion || 'not_run' }}
        run: |
          echo "### Email" >> "$GITHUB_STEP_SUMMARY"
          echo "- send_email input: ${{ inputs.send_email }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- can_email: ${{ steps.email_config.outputs.can_email }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- missing: ${{ steps.email_config.outputs.missing }}" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ inputs.send_email }}" = "true" ] && [ "${{ steps.email_config.outputs.can_email }}" = "true" ]; then
            echo "- attempted: true (see Send email step)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- attempted: false" >> "$GITHUB_STEP_SUMMARY"
          fi
