name: Backfill & Backtest

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date (YYYY-MM-DD)"
        required: false
        default: ""
      end_date:
        description: "End date (YYYY-MM-DD)"
        required: false
        default: ""
      model:
        description: "Model identifier"
        required: false
        default: "LOGIT_WIN_PLACE_V0"

env:
  PYTHON_VERSION: "3.11"
  # Make repo-root imports work for *every* python invocation
  PYTHONPATH: ${{ github.workspace }}

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Hard fail if anyone reintroduces file-mode CLI invocation
      - name: Guardrail: forbid file-mode CLI
        run: |
          if grep -RIn --line-number -E 'python\s+cli/turf_cli\.py' .github/workflows; then
            echo "::error ::File-mode CLI invocation found in workflows. Use: python -m cli.turf_cli"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve date window
        id: dates
        run: |
          START="${{ github.event.inputs.start_date }}"
          END="${{ github.event.inputs.end_date }}"
          if [ -z "$START" ]; then START="$(date -u +%Y-%m-%d)"; fi
          if [ -z "$END" ]; then END="$START"; fi
          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "end=$END" >> "$GITHUB_OUTPUT"

      - name: Init DB
        run: |
          python tools/db_init_if_missing.py --db data/turf.duckdb

      - name: Build demo cards (module mode)
        run: |
          python -m cli.turf_cli demo-run --date "${{ steps.dates.outputs.start }}" --out out/cards

      - name: Append forecasts to DB
        run: |
          python tools/db_append.py --db data/turf.duckdb --cards out/cards --model "${{ github.event.inputs.model || 'LOGIT_WIN_PLACE_V0' }}"

      - name: Backtest window
        run: |
          python tools/backtest.py --db data/turf.duckdb --model "${{ github.event.inputs.model || 'LOGIT_WIN_PLACE_V0' }}" --start "${{ steps.dates.outputs.start }}" --end "${{ steps.dates.outputs.end }}" --out out/reports

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turf-backtest-${{ steps.dates.outputs.start }}
          path: |
            data/turf.duckdb
            out/cards/*.json
            out/reports/backtest_metrics.json

      - name: Job summary
        run: |
          echo "### Backfill & backtest" >> $GITHUB_STEP_SUMMARY
          echo "- Range: ${{ steps.dates.outputs.start }} to ${{ steps.dates.outputs.end }}" >> $GITHUB_STEP_SUMMARY
          if [ -f out/reports/backtest_metrics.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Metrics:" >> $GITHUB_STEP_SUMMARY
            cat out/reports/backtest_metrics.json >> $GITHUB_STEP_SUMMARY
          fi
