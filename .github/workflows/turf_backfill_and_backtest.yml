name: Backfill & Backtest

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date (YYYY-MM-DD)"
        required: true
        default: "2025-12-01"
      end_date:
        description: "End date (YYYY-MM-DD)"
        required: true
        default: "2025-12-15"
      model:
        description: "Model/profile selector (if supported by your pipeline)"
        required: false
        default: "lite"

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  PYTHONPATH: ${{ github.workspace }}

jobs:
  backfill:
    name: Backfill + Backtest
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Hard fail if anyone reintroduces file-mode CLI invocation
      - name: "Guardrail: forbid file-mode CLI"
        run: |
          if grep -RIn --line-number -E 'python\s+cli/turf_cli\.py' .github/workflows; then
            echo "::error::File-mode CLI invocation found in workflows. Use: python -m cli.turf_cli"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-dev.txt
          python -m pip install -e .

      - name: Run backfill & backtest
        run: |
          set -euxo pipefail
          mkdir -p out/backfill out/backtest out/diagnostics

          # Run backtest using tools/backtest.py
          # Note: Script expects --start/--end, not --start-date/--end-date
          python tools/backtest.py \
            --start "${{ inputs.start_date }}" \
            --end "${{ inputs.end_date }}" \
            --model "${{ inputs.model }}" \
            --out out/backtest

      - name: Diagnostics (optional)
        if: ${{ always() }}
        run: |
          set -euxo pipefail
          if [ -f scripts/diagnostics.py ]; then
            python scripts/diagnostics.py --out out/diagnostics || true
          fi

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: backfill_backtest_${{ inputs.start_date }}_to_${{ inputs.end_date }}
          path: |
            out/**
            !out/**/__pycache__/**
